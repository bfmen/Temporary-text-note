var hasPassword = false;
function passwordRequest_Add(a) {
    var b = (document.getElementById("notepwd")) ? document.getElementById("notepwd").value: "";
    if (!isEmpty(b)) {
        a = a + "&notepwd=" + encodeURIComponent(b)
    }
    var c = document.getElementById("allowReadOnlyView");
    if (c && c.checked) {
        a = a + "&allowReadOnlyView=1"
    }
    return a
}
function passwordRequest_Remove(b) {
    var a = (document.getElementById("hdnRemovePassword")) ? document.getElementById("hdnRemovePassword").value: "";
    if (!isEmpty(a)) {
        b = b + "&removePassword=" + encodeURIComponent(a)
    }
    return b
}
function metadataGet(a) {
    if (!isEmpty(notepwd)) {
        a = a + "&metadataGet=1"
    }
    return a
}
function isEmpty(a) {
    return (a == null || a.length === 0)
}
function handlePasswordAction() {
    var a = document.getElementById("notepwd");
    var b = a ? a.value: "";
    if (!b || b.length === 0) {
        showPasswordMessage("请输入密码", "error");
        if (a) {
            a.focus()
        }
        return
    }
    if (window.hasPassword) {
        removePasswordAction()
    } else {
        setPasswordAction()
    }
}
function setPasswordAction() {
    showPasswordMessage("正在设置密码保护...", "info");
    var a = document.getElementById("submitpwd");
    if (a) {
        a.disabled = true;
        a.innerHTML = "设置中..."
    }
    if (typeof uploadContent === "function") {
        uploadContent(true)
    }
    setTimeout(function() {
        window.hasPassword = true;
        updatePasswordUI();
        if (a) {
            a.disabled = false
        }
        if (typeof toggleModal_Password === "function") {
            toggleModal_Password()
        }
        showGlobalPasswordMessage("密码保护已设置成功！", "success")
    },
    500)
}
function removePasswordAction() {
    showPasswordMessage("正在移除密码保护...", "info");
    var a = document.getElementById("submitpwd");
    if (a) {
        a.disabled = true;
        a.innerHTML = "移除中..."
    }
    var b = document.getElementById("hdnRemovePassword");
    if (b) {
        b.value = "1"
    }
    var c = "";
    if (typeof textarea !== "undefined" && textarea) {
        c = textarea.value
    }
    if (typeof uploadContent === "function") {
        uploadContent(true)
    }
    if (b) {
        b.value = ""
    }
    setTimeout(function() {
        var d = "";
        if (typeof textarea !== "undefined" && textarea) {
            d = textarea.value
        }
        if (c === d && window.hasPassword) {
            showPasswordMessage("密码错误，无法移除密码保护", "error");
            if (a) {
                a.disabled = false;
                a.innerHTML = "移除密码"
            }
            var e = document.getElementById("notepwd");
            if (e) {
                e.value = "";
                e.focus()
            }
        } else {
            window.hasPassword = false;
            updatePasswordUI();
            if (a) {
                a.disabled = false
            }
            if (typeof toggleModal_Password === "function") {
                toggleModal_Password()
            }
            showGlobalPasswordMessage("密码保护已成功移除！", "success")
        }
    },
    800)
}
function updatePasswordUI() {
    var a = document.getElementById("submitpwd");
    var b = document.getElementById("passwordLabel");
    var c = document.getElementById("readOnlyGroup");
    if (window.hasPassword) {
        if (a) {
            a.innerHTML = "移除密码";
            a.className = "submit danger-btn"
        }
        if (b) {
            b.innerHTML = "输入当前密码以移除保护："
        }
        if (c) {
            c.style.display = "none"
        }
    } else {
        if (a) {
            a.innerHTML = "设置密码";
            a.className = "submit primary-btn"
        }
        if (b) {
            b.innerHTML = "设置密码："
        }
        if (c) {
            c.style.display = "block"
        }
    }
}
function showPasswordMessage(b, c) {
    var a = document.getElementById("pwdMessage");
    if (a) {
        a.innerHTML = b;
        a.className = "message " + (c || "")
    }
}
function showGlobalPasswordMessage(b, c) {
    var a = document.createElement("div");
    a.style.cssText = "position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 4px; font-family: sans-serif; font-size: 14px; z-index: 10000; box-shadow: 0 2px 8px rgba(0,0,0,0.2); transition: opacity 0.3s ease;";
    if (c === "success") {
        a.style.backgroundColor = "#d4edda";
        a.style.color = "#155724";
        a.style.border = "1px solid #c3e6cb"
    } else if (c === "error") {
        a.style.backgroundColor = "#f8d7da";
        a.style.color = "#721c24";
        a.style.border = "1px solid #f5c6cb"
    }
    a.innerHTML = b;
    document.body.appendChild(a);
    setTimeout(function() {
        a.style.opacity = "0";
        setTimeout(function() {
            if (a.parentNode) {
                a.parentNode.removeChild(a)
            }
        },
        300)
    },
    3000)
}
function detectPasswordStatus() {
    return hasPassword
}
function showRemovePassword() {
    window.hasPassword = true;
    updatePasswordUI()
}
function checkPasswordStrength(a) {
    if (a.length < 4) {
        return {
            strength: "weak",
            message: "密码太短，建议至少4个字符"
        }
    } else {
        if (a.length < 8) {
            return {
                strength: "medium",
                message: "密码强度一般"
            }
        } else {
            return {
                strength: "strong",
                message: "密码强度良好"
            }
        }
    }
}
function setupPasswordStrengthIndicator() {
    var a = document.getElementById("notepwd");
    if (a) {
        a.addEventListener("input",
        function() {
            var b = this.value;
            if (b.length > 0 && !window.hasPassword) {
                var c = checkPasswordStrength(b);
                showPasswordMessage(c.message, c.strength === "strong" ? "success": "info")
            } else {
                showPasswordMessage("", "")
            }
        })
    }
}

var passwordInput = document.getElementById("notepwd");
if (passwordInput) {
    passwordInput.addEventListener("keyup",
    function(a) {
        a.preventDefault();
        if (a.keyCode === 13) {
            document.getElementById("submitpwd").click()
        }
    });
    setupPasswordStrengthIndicator()
}
function initPasswordModal() {
    var a = document.getElementById("notepwd");
    if (a) {
        a.focus();
        a.value = "";
        a.addEventListener("keyup",
        function(b) {
            b.preventDefault();
            if (b.keyCode === 13) {
                document.getElementById("submitpwd").click()
            }
        })
    }
    showPasswordMessage("", "");
    updatePasswordUI()
}
document.addEventListener("DOMContentLoaded",
function() {
    var a = document.getElementById("password_modal");
    if (a) {
        var b = new MutationObserver(function(c) {
            c.forEach(function(d) {
                if (d.type === "attributes" && d.attributeName === "class") if (a.classList.contains("show-modal")) setTimeout(initPasswordModal, 100)
            })
        });
        b.observe(a, {
            attributes: true
        })
    }
});
function submitPassword() {
    handlePasswordAction()
}
function passwordRemove() {
    removePasswordAction()
};